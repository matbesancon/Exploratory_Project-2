---
title: "Exploratory Data Analysis - Particles Emission"
author: "Mathieu Besan√ßon"
date: "Tuesday, September 09, 2014"
output: html_document
---

## Introduction


This report aims at giving a quick overview of the particle emissions in the USA, based on the exploratory analysis of data provided by the the Environmental Protection Agency (EPA) and made publicly available. We will use data from the years 1999, 2002, 2005, and 2008.  
  
The purpose is to put in a proper report the graphs produced for the second project of **Exploratory Data Analysis**, an online course offered by the John Hopkins University on the Coursera plateform. You can have an overview of the course [here](https://www.coursera.org/course/exdata). 

### Pre-processing


We begin by loading the data :
```{r}
part_data=readRDS("summarySCC_PM25.rds")
SCC <- readRDS("Source_Classification_Code.rds")
```
We store in *part_data* the particle emissions data and in SCC the Source Classification Code of each emission type. For some of the plots, we will need the package *ggplot2*. We will also be using the function *multiplot* for this package, available [here](http://www.cookbook-r.com/Graphs/Multiple_graphs_on_one_page_(ggplot2)/).

```{r,results='hide'}
library(ggplot2)
```
The function multiplot is hidden to keep the document short. You can visite the website to see the details, the code remained untouched.  
```{r,echo=FALSE,results='hide'}
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
        require(grid)
        
        # Make a list from the ... arguments and plotlist
        plots <- c(list(...), plotlist)
        
        numPlots = length(plots)
        
        # If layout is NULL, then use 'cols' to determine layout
        if (is.null(layout)) {
                # Make the panel
                # ncol: Number of columns of plots
                # nrow: Number of rows needed, calculated from # of cols
                layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                                 ncol = cols, nrow = ceiling(numPlots/cols))
        }
        
        if (numPlots==1) {
                print(plots[[1]])
                
        } else {
                # Set up the page
                grid.newpage()
                pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
                
                # Make each plot, in the correct location
                for (i in 1:numPlots) {
                        # Get the i,j matrix positions of the regions that contain this subplot
                        matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
                        
                        print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                                        layout.pos.col = matchidx$col))
                }
        }
}
```
We can quickly look at the data to see on what exactly we are working :
What are the attributes of the particle emissions data :
```{r}
names(part_data)
```
How big is our data set :
```{r}
dim(part_data)
```
What contains every line :
```{r}
part_data[1,]
```

### Plot I : Overall particle emissions in the US across the years

First of all, we aggregate the emissions data per year.
```{r}
agg_part<-aggregate(part_data$Emissions,list(part_data$year),FUN=sum)
```
The base plot system is used to create a simple plot of the data :
```{r}
plot(agg_part$Group.1,agg_part$x,main="Particle emissions in the US",xlab="Year",ylab="Particle emission (T)",pch='+')
lines(agg_part$Group.1,agg_part$x,col="blue")
```
  
### Plot II : Particle emissions per year in Baltimore

Baltimore is identified by the fips code "24510". We create a subset of the data only with the corresponding fips code, 
and aggregate the emissions per year.

```{r}
balti_data<-subset(part_data,fips=="24510") 
4 agg_balti<-aggregate(balti_data$Emissions,list(balti_data$year),FUN=sum) 
```
We can then generate the plot.
```{r}
plot(agg_balti$Group.1,agg_balti$x,main="Particle emissions in Baltimore",xlab="Year",ylab="Particle emission (T)",pch="+") 
lines(agg_balti$Group.1,agg_balti$x,col="purple") 
```

### Plot III : Emissions per type in Baltimore across years

Firstly, we each type from the Baltimore data we created for Plot 2.
```{r}
sub_point<-subset(balti_data,type=='POINT') 
sub_non_point<-subset(balti_data,type=='NONPOINT') 
sub_onroad<-subset(balti_data,type=='ON-ROAD') 
sub_non_road<-subset(balti_data,type=='NON-ROAD') 
 ```
 The data of each type are aggregated per year : 
```{r}
agg_point<-aggregate(sub_point$Emissions,list(sub_point$year),FUN=sum) 
agg_non_point<-aggregate(sub_non_point$Emissions,list(sub_non_point$year),FUN=sum) 
agg_onroad<-aggregate(sub_onroad$Emissions,list(sub_onroad$year),FUN=sum) 
agg_non_road<-aggregate(sub_non_road$Emissions,list(sub_non_road$year),FUN=sum) 
```
In order to display all the plot at once, we store them in objects, 
and call the multiplot function with these objects as arguments.

```{r}
plot_point<-qplot(Group.1,x,main="Particle emissions for Point",data=agg_point,xlab="Year",ylab="Particle emissions (T)",geom=c("point")) +geom_line(colour='red') 
plot_onroad<-qplot(Group.1,x,main="Particle emissions for On-Road",data=agg_onroad,xlab="Year",ylab="Particle emissions (T)",geom=c("point"))+geom_line(colour='blue') 
plot_non_point<-qplot(Group.1,x,main="Particle emissions for Non-Point",data=agg_non_point,xlab="Year",ylab="Particle emissions (T)",geom=c("point"))+geom_line(colour='purple') 
plot_non_road<-qplot(Group.1,x,main="Particle emissions for Non-Road",data=agg_non_road,xlab="Year",ylab="Particle emissions (T)",geom=c("point"))+geom_line(colour='orange') 
 
multiplot(plot_point,plot_onroad,plot_non_point,plot_non_road,cols=2)
```

### Plot IV : Emissions from coal combustion 

In order to find the emissions codes related to coal combustion, we look for the emissions types names containing "Coal-fired".
We extract the indexes of these emissions categories and create a subset of the classification data with those indexes.
```{r}
index_coal<-which(grepl('Coal-fired',SCC$Short.Name)==TRUE) 
sub_coal<-SCC[index_coal,] 
```
Then, a subset of the emissions data, *coal_data* can be generated based on their SCC code, which has to belong to the coal-fired categories.
```{r}
coal_data<-part_data[which(part_data$SCC%in%sub_coal$SCC),]
```

The *coal_data* subset can then be aggregated per year as done before, and the plot can be generated.
```{r}
attach(coal_data) 
agg_coal<-aggregate(Emissions,list(year),FUN=sum) 
detach(coal_data) 

p<-qplot(agg_coal[,1],agg_coal[,2],ylim=c(0,NA),main='Coal combustion related emissions in the US', 
xlab="Year",ylab="Particle emissions (T)",size=5) 
p<-p+geom_line(size=0.5,col="orange") 
p<-p+theme(legend.position="none") 
print(p)
```




